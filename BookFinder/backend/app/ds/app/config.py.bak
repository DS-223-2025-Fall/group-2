"""
Configuration management for DS service
Loads settings from environment variables with sensible defaults
"""
import os
from pathlib import Path
from dotenv import load_dotenv

# Get base directory (ds/) - relative to this config file
_CONFIG_DIR = Path(__file__).resolve().parent  # ds/app/ (absolute)
_BASE_DIR = _CONFIG_DIR.parent                  # ds/ (absolute)

# DEBUG: Print to see what's happening
print(f"[CONFIG DEBUG] __file__ = {__file__}")
print(f"[CONFIG DEBUG] _CONFIG_DIR = {_CONFIG_DIR}")
print(f"[CONFIG DEBUG] _BASE_DIR = {_BASE_DIR}")
print(f"[CONFIG DEBUG] vector_stores will be at: {_BASE_DIR / 'vector_stores'}")

# Load environment variables from .env file
env_path = _BASE_DIR / '.env'
load_dotenv(dotenv_path=env_path)


class Config:
    """Configuration class for DS service"""
    
    # OpenAI API Configuration
    OPENAI_API_KEY = os.getenv('OPENAI_API_KEY', '')
    OPENAI_MODEL = os.getenv('OPENAI_MODEL', 'gpt-4')
    OPENAI_TEMPERATURE = float(os.getenv('OPENAI_TEMPERATURE', '0.3'))
    OPENAI_MAX_TOKENS = int(os.getenv('OPENAI_MAX_TOKENS', '300'))
    
    # Embedding Model Configuration
    EMBEDDING_MODEL = os.getenv('EMBEDDING_MODEL', 'all-MiniLM-L6-v2')
    
    # Vector Store Configuration
    # Use environment variable if set, otherwise use absolute path to ds/vector_stores
    VECTOR_STORE_PATH = Path(os.getenv('VECTOR_STORE_PATH')) if os.getenv('VECTOR_STORE_PATH') else _BASE_DIR / 'vector_stores'
    CACHE_PATH = Path(os.getenv('CACHE_PATH')) if os.getenv('CACHE_PATH') else _BASE_DIR / 'cache'
    
    # Recommendation Settings
    TOP_K_RESULTS = int(os.getenv('TOP_K_RESULTS', '5'))
    
    @classmethod
    def validate(cls):
        """Validate that required configuration is present"""
        if not cls.OPENAI_API_KEY:
            raise ValueError("OPENAI_API_KEY is required. Please set it in .env file")
        
        # Create necessary directories
        cls.VECTOR_STORE_PATH.mkdir(parents=True, exist_ok=True)
        cls.CACHE_PATH.mkdir(parents=True, exist_ok=True)
    
    @classmethod
    def get_cache_path(cls, cache_type: str) -> Path:
        """Get cache file path for specific cache type"""
        # Ensure directory exists
        cls.CACHE_PATH.mkdir(parents=True, exist_ok=True)
        return cls.CACHE_PATH / f"{cache_type}_cache.json"


# Create a singleton instance
config = Config()
